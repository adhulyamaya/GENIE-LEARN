{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="chat-container" style="max-width: 600px; margin: 20px auto;">
    <h2>Chat with Mentor: {{ mentor.full_name }}</h2>
    <div id="chat-box" style="border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; margin-bottom: 10px;">
        <!-- Messages will appear here -->
    </div>
    <form id="chat-form">
        <input type="text" id="message-input" placeholder="Type your message..." style="width: 80%;" required />
        <button type="submit">Send</button>
    </form>
</div>

<script>
    const courseId = {{ course.id }};
    const senderId = {{ student.id }};
    const receiverId = {{ mentor.id }};
    const socket = new WebSocket(
        'ws://' + window.location.host + `/ws/chat/support/${courseId}/`
    );

    const chatBox = document.getElementById('chat-box');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('message-input');

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const messageElement = document.createElement('div');
        messageElement.innerText = data.sender_id === senderId ? `You: ${data.message}` : `Mentor: ${data.message}`;
        chatBox.appendChild(messageElement);
        chatBox.scrollTop = chatBox.scrollHeight;
    };

    socket.onopen = function() {
        console.log('WebSocket connected');
    };

    socket.onclose = function() {
        console.log('WebSocket disconnected');
    };

    form.onsubmit = function(e) {
        e.preventDefault();
        const message = input.value;
        if (message.trim() === '') return;

        socket.send(JSON.stringify({
            'message': message,
            'sender_id': senderId,
            'receiver_id': receiverId
        }));

        input.value = '';
    };
</script>
{% endblock %}
